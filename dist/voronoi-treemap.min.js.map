{"version":3,"file":"voronoi-treemap.min.js","sources":["../src/utils/d3-bundle.js","../src/PebbleRenderer.js","../src/LabelAdjuster.js","../src/nestingForVoronoi.js","../src/VoronoiTreemapHelpers.js","../src/VoronoiTreemap.js","../src/PopupHelpers.js"],"sourcesContent":["/**\n * D3 Bundle Utility\n *\n * This module aggregates D3 core with voronoi extension libraries:\n * - d3 (core D3 library)\n * - d3-weighted-voronoi\n * - d3-voronoi-map\n * - d3-voronoi-treemap\n * - seedrandom\n *\n * The bundled d3 object is used throughout the library to ensure\n * all voronoi treemap methods are available on a single namespace.\n *\n * Original Observable require pattern:\n *   require(\"d3\", \"d3-weighted-voronoi\", \"d3-voronoi-map\", \"d3-voronoi-treemap\", \"seedrandom@2.4.3/seedrandom.min.js\")\n */\n\nimport * as d3Core from 'd3';\nimport * as d3WeightedVoronoi from 'd3-weighted-voronoi';\nimport * as d3VoronoiMap from 'd3-voronoi-map';\nimport * as d3VoronoiTreemap from 'd3-voronoi-treemap';\nimport * as seedrandomModule from 'seedrandom';\n\n/**\n * Merged D3 namespace with all voronoi treemap extensions\n * This replicates the Observable require behavior:\n *   require(\"d3\", \"d3-weighted-voronoi\", \"d3-voronoi-map\", \"d3-voronoi-treemap\", \"seedrandom\")\n * which merges all modules into a single namespace.\n */\nconst d3 = Object.assign(\n  {},\n  d3Core,\n  d3WeightedVoronoi,\n  d3VoronoiMap,\n  d3VoronoiTreemap\n);\n\n// Attach seedrandom for reproducible random number generation\n// This allows usage like: d3.seedrandom('myseed')\nd3.seedrandom = seedrandomModule.default || seedrandomModule;\n\nexport default d3;\n","/**\n * PebbleRenderer\n *\n * Renders smooth \"pebble-like\" outlines around voronoi treemap cells.\n * Creates rounded corner effects for depth-1 (region) and depth-2\n * (cluster) boundaries to give the treemap a polished, organic appearance.\n *\n * Features:\n * - Smooth path generation with configurable corner radius\n * - Color variation for depth-2 outlines\n * - Point simplification for cleaner paths\n */\n\nimport d3 from './utils/d3-bundle.js';\n\n/**\n * PebbleRenderer - Smooth outline renderer for voronoi treemaps\n *\n * This class provides methods to render smooth, rounded outlines\n * around voronoi treemap cells at different depth levels.\n */\nexport class PebbleRenderer {\n  /**\n   * Create a PebbleRenderer instance\n   * @param {Object} [d3Instance] - Optional D3 instance (defaults to global d3)\n   */\n  constructor(d3Instance) {\n    this.d3 = d3Instance || d3;\n  }\n\n  /**\n   * Render pebble-style outlines for a treemap SVG\n   * @param {SVGElement} treemap - The SVG element containing the treemap\n   * @param {number} [round=10] - Corner radius for smoothing\n   * @param {number} [width=3] - Stroke width for depth-1 outlines\n   * @param {Function} [colorVarFunc] - Optional color variation function\n   */\n  render(treemap, round = 10, width = 3, colorVarFunc) {\n    const container = this.d3.select(treemap);\n    const cell = container.select('g.cell');\n\n    if (cell.empty()) {\n      return;\n    }\n\n    const chartGroup = this.d3.select(cell.node().parentNode);\n\n    chartGroup.select('.cell-outline').remove();\n    chartGroup.select('.cell-outline2').remove();\n\n    const outlineGroup = chartGroup\n      .insert('g', 'g.cell + *')\n      .attr('class', 'cell-outline');\n\n    const outlineGroup2 = chartGroup\n      .insert('g', 'g.cell + *')\n      .attr('class', 'cell-outline')\n      .attr('id', 'outline2');\n\n    this._renderDepth2Outlines(cell, outlineGroup2, colorVarFunc);\n    this._renderDepth1Outlines(cell, outlineGroup, round, width);\n  }\n\n  /**\n   * Render outlines for depth-2 cells (cluster level)\n   * @param {Object} cell - D3 selection of cell group\n   * @param {Object} outlineGroup - D3 selection of outline group\n   * @param {Function} [colorVarFunc] - Optional color variation function\n   * @private\n   */\n  _renderDepth2Outlines(cell, outlineGroup, colorVarFunc) {\n    const self = this;\n\n    cell.selectAll('.regionArea2').each(function (datum) {\n      const path = self.d3.select(this);\n      const polygon = datum.polygon;\n\n      const cellColor = colorVarFunc\n        ? colorVarFunc(datum.parent.color, 0, -0.2, -0.15)\n        : self._defaultColorVar(datum.parent.color, 0, -0.2, -0.15);\n\n      path.style('stroke', cellColor);\n\n      if (polygon && polygon.length > 0) {\n        const originalPath =\n          'M' + polygon.map((p) => `${p[0]},${p[1]}`).join('L') + 'Z';\n        const smoothedPath = self.smoothPath(originalPath, 8, 2);\n\n        outlineGroup\n          .append('path')\n          .attr('d', `${originalPath} ${smoothedPath}`)\n          .attr('fill', cellColor)\n          .attr('stroke', cellColor)\n          .attr('stroke-width', 0)\n          .style('fill-rule', 'evenodd');\n      }\n    });\n  }\n\n  /**\n   * Render outlines for depth-1 cells (region level)\n   * @param {Object} cell - D3 selection of cell group\n   * @param {Object} outlineGroup - D3 selection of outline group\n   * @param {number} round - Corner radius for smoothing\n   * @param {number} width - Stroke width\n   * @private\n   */\n  _renderDepth1Outlines(cell, outlineGroup, round, width) {\n    const self = this;\n\n    cell.selectAll('.regionArea1').each(function (datum) {\n      const polygon = datum.polygon;\n\n      if (polygon && polygon.length > 0) {\n        const originalPath =\n          'M' + polygon.map((p) => `${p[0]},${p[1]}`).join('L') + 'Z';\n        const smoothedPath = self.smoothPath(originalPath, round);\n\n        outlineGroup\n          .append('path')\n          .attr('d', `${originalPath} ${smoothedPath}`)\n          .attr('fill', '#555')\n          .attr('stroke', '#555')\n          .attr('stroke-width', width)\n          .style('fill-rule', 'evenodd');\n      }\n    });\n  }\n\n  /**\n   * Generate a smoothed SVG path with rounded corners\n   * @param {string} pathData - Original SVG path data (M...L...Z format)\n   * @param {number} [cornerRadius=10] - Radius for corner rounding\n   * @param {number} [minDistanceThreshold=0] - Minimum distance between points\n   * @returns {string} Smoothed SVG path data\n   */\n  smoothPath(pathData, cornerRadius = 10, minDistanceThreshold = 0) {\n    const rawPoints = pathData\n      .replace(/[MZ]/gi, '')\n      .split('L')\n      .map((d) => d.trim().split(',').map(Number))\n      .filter(([x, y]) => !isNaN(x) && !isNaN(y));\n\n    if (rawPoints.length < 3) return pathData;\n\n    let simplifiedPoints = this._simplifyPoints(rawPoints, minDistanceThreshold);\n\n    if (simplifiedPoints.length < 3) return pathData;\n\n    const n = simplifiedPoints.length;\n    let newPath = '';\n\n    for (let i = 0; i < n; i++) {\n      const p0 = simplifiedPoints[(i - 1 + n) % n];\n      const p1 = simplifiedPoints[i];\n      const p2 = simplifiedPoints[(i + 1) % n];\n\n      const vIn = { x: p0[0] - p1[0], y: p0[1] - p1[1] };\n      const vOut = { x: p2[0] - p1[0], y: p2[1] - p1[1] };\n      const lenIn = Math.hypot(vIn.x, vIn.y);\n      const lenOut = Math.hypot(vOut.x, vOut.y);\n\n      if (lenIn < 1e-7 || lenOut < 1e-7) continue;\n\n      const inNorm = { x: vIn.x / lenIn, y: vIn.y / lenIn };\n      const outNorm = { x: vOut.x / lenOut, y: vOut.y / lenOut };\n\n      const dot = inNorm.x * outNorm.x + inNorm.y * outNorm.y;\n      let angle = Math.acos(Math.max(-1, Math.min(1, dot)));\n\n      const adjustedRadius =\n        angle < Math.PI / 4.5 ? cornerRadius / 2 : cornerRadius;\n      const halfAngle = angle / 2;\n      const maxRadiusByLength = Math.min(lenIn, lenOut) / 2.1;\n      const d = Math.min(\n        lenIn,\n        lenOut,\n        adjustedRadius / Math.tan(halfAngle),\n        maxRadiusByLength / Math.tan(halfAngle)\n      );\n\n      const pStart = [p1[0] + inNorm.x * d, p1[1] + inNorm.y * d];\n      const pEnd = [p1[0] + outNorm.x * d, p1[1] + outNorm.y * d];\n\n      newPath +=\n        i === 0\n          ? `M${pStart[0]},${pStart[1]}`\n          : ` L${pStart[0]},${pStart[1]}`;\n      newPath += ` Q${p1[0]},${p1[1]} ${pEnd[0]},${pEnd[1]}`;\n    }\n\n    newPath += 'Z';\n    return newPath;\n  }\n\n  /**\n   * Simplify polygon points by removing those too close together\n   * @param {Array} rawPoints - Array of [x, y] coordinate pairs\n   * @param {number} minDistanceThreshold - Minimum distance between points\n   * @returns {Array} Simplified array of points\n   * @private\n   */\n  _simplifyPoints(rawPoints, minDistanceThreshold) {\n    if (minDistanceThreshold <= 0 || rawPoints.length <= 3) {\n      return rawPoints;\n    }\n\n    const tempPoints = [rawPoints[0]];\n    let lastPoint = rawPoints[0];\n\n    for (let i = 1; i < rawPoints.length; i++) {\n      const currentPoint = rawPoints[i];\n      const dist = Math.hypot(\n        currentPoint[0] - lastPoint[0],\n        currentPoint[1] - lastPoint[1]\n      );\n\n      if (dist >= minDistanceThreshold) {\n        tempPoints.push(currentPoint);\n        lastPoint = currentPoint;\n      }\n    }\n\n    const firstPoint = tempPoints[0];\n    const lastAddedPoint = tempPoints[tempPoints.length - 1];\n    if (lastAddedPoint !== firstPoint) {\n      const dist = Math.hypot(\n        firstPoint[0] - lastAddedPoint[0],\n        firstPoint[1] - lastAddedPoint[1]\n      );\n      if (dist < minDistanceThreshold) {\n        tempPoints.pop();\n      }\n    }\n\n    return tempPoints.length >= 3 ? tempPoints : rawPoints;\n  }\n\n  /**\n   * Generate a color variation using HSL adjustments\n   * @param {string} color - Base color (any CSS color format)\n   * @param {number} [h=0] - Hue adjustment\n   * @param {number} [l=0] - Lightness adjustment\n   * @param {number} [s=0] - Saturation adjustment\n   * @returns {string} Adjusted color in hex format\n   * @private\n   */\n  _defaultColorVar(color, h = 0, l = 0, s = 0) {\n    let c = this.d3.hsl(color);\n    c.h += h;\n    c.l += l;\n    c.s += s;\n    if (c.l > 0.95) c.l = 0.95;\n    return c.formatHex();\n  }\n}\n\nexport default PebbleRenderer;\n","/**\n * LabelAdjuster\n *\n * Handles automatic label collision detection and position adjustment\n * for voronoi treemap visualizations. Adjusts label positions to prevent\n * overlapping between:\n * - Field labels and region labels\n * - Sector labels and field labels\n *\n * Uses setTimeout-based deferred processing to ensure DOM elements\n * are fully rendered before measuring and adjusting positions.\n */\n\nimport d3 from './utils/d3-bundle.js';\n\n/**\n * LabelAdjuster - Label collision detection and adjustment\n *\n * This class provides methods to automatically adjust label positions\n * in voronoi treemaps to prevent overlapping text elements.\n */\nexport class LabelAdjuster {\n  /**\n   * Create a LabelAdjuster instance\n   * @param {Object} [d3Instance] - Optional D3 instance (defaults to global d3)\n   */\n  constructor(d3Instance) {\n    this.d3 = d3Instance || d3;\n  }\n\n  /**\n   * Adjust label positions in a treemap SVG to prevent overlapping\n   * @param {SVGElement} treemap - The SVG element containing the treemap\n   * @param {Object} [options={}] - Adjustment options\n   * @param {number} [options.verticalSpacing=0] - Additional vertical spacing between labels\n   * @param {number} [options.delay=100] - Delay in ms before adjustment (for DOM rendering)\n   */\n  adjust(treemap, options = {}) {\n    const { verticalSpacing = 0, delay = 100 } = options;\n    const d3 = this.d3;\n\n    setTimeout(() => {\n      const svg = d3.select(treemap);\n\n      svg.selectAll(\".field\").each(function () {\n        adjustFieldLabel(d3.select(this));\n      });\n\n      svg.selectAll(\".sector\").each(function () {\n        adjustSectorLabel(d3.select(this));\n      });\n    }, delay);\n\n    /**\n     * Parse SVG transform attribute to extract x, y translation\n     * @param {string} transform - Transform attribute string\n     * @returns {Object} { x, y } translation values\n     */\n    function parseTransform(transform) {\n      if (!transform) return { x: 0, y: 0 };\n      const match = transform.match(/translate\\(([^,]+),([^)]+)\\)/);\n      if (!match) return { x: 0, y: 0 };\n      return { x: parseFloat(match[1]), y: parseFloat(match[2]) };\n    }\n\n    /**\n     * Check if two bounding boxes overlap\n     * @param {Object} box1 - First bounding box\n     * @param {Object} box2 - Second bounding box\n     * @returns {boolean} True if boxes overlap\n     */\n    function checkOverlap(box1, box2) {\n      const margin = verticalSpacing / 2;\n      const marginx = -3;\n      return !(\n        box1.x + box1.width / 2 + marginx < box2.x - box2.width / 2 ||\n        box1.x - box1.width / 2 - marginx > box2.x + box2.width / 2 ||\n        box1.y + box1.height / 2 + margin < box2.y - box2.height / 2 ||\n        box1.y - box1.height / 2 - margin > box2.y + box2.height / 2\n      );\n    }\n\n    /**\n     * Calculate required vertical move distance to resolve overlap\n     * @param {Object} box1 - First bounding box\n     * @param {Object} box2 - Second bounding box\n     * @returns {number} Required move distance\n     */\n    function getRequiredMoveDistance(box1, box2) {\n      const margin = verticalSpacing / 2;\n      const box1Top = box1.y - box1.height / 2 - margin;\n      const box1Bottom = box1.y + box1.height / 2 + margin;\n      const box2Top = box2.y - box2.height / 2 - margin;\n      const box2Bottom = box2.y + box2.height / 2 + margin;\n\n      if (box1Bottom <= box2Top || box1Top >= box2Bottom) return 0;\n      if (box1.y < box2.y) return box1Bottom - box2Top;\n      return box2Bottom - box1Top;\n    }\n\n    /**\n     * Get bounding box information for a label element\n     * @param {Object} element - D3 selection of label element\n     * @returns {Object|null} Bounding box info or null if element invalid\n     */\n    function getLabelBox(element) {\n      const node = element.node();\n      if (!node) return null;\n\n      const bbox = node.getBBox();\n      let { width, height } = bbox;\n      const tspanCount = element.selectAll(\"tspan tspan\").size() || 1;\n      const transform = parseTransform(element.attr(\"transform\"));\n\n      return {\n        originalX: transform.x,\n        originalY: transform.y,\n        x: transform.x + width / 2,\n        y: transform.y + height / 2,\n        width,\n        height,\n        tspanCount\n      };\n    }\n\n    /**\n     * Get cell polygon bounds from node data\n     * @param {Object} data - Node data with polygon\n     * @returns {Object|null} { minX, maxX, minY, maxY } or null\n     */\n    function getCellBounds(data) {\n      if (!data || !data.polygon) return null;\n      const xs = data.polygon.map((p) => p[0]);\n      const ys = data.polygon.map((p) => p[1]);\n      return {\n        minX: Math.min(...xs),\n        maxX: Math.max(...xs),\n        minY: Math.min(...ys),\n        maxY: Math.max(...ys)\n      };\n    }\n\n    /**\n     * Calculate minimum move position to avoid overlap\n     * @param {Object} labelBox - Label bounding box\n     * @param {Object} parentBox - Parent label bounding box\n     * @param {Object} cellBounds - Cell polygon bounds\n     * @returns {Object} { x, y } new position\n     */\n    function findMinimumMove(labelBox, parentBox, cellBounds) {\n      if (\n        labelBox.x + labelBox.width / 2 < parentBox.x - parentBox.width / 2 ||\n        labelBox.x - labelBox.width / 2 > parentBox.x + parentBox.width / 2\n      ) {\n        return { x: labelBox.originalX, y: labelBox.originalY };\n      }\n\n      const moveDistance = getRequiredMoveDistance(labelBox, parentBox);\n      if (moveDistance === 0) {\n        return { x: labelBox.originalX, y: labelBox.originalY };\n      }\n\n      const originallyAbove = labelBox.y < parentBox.y;\n      let newY = labelBox.y;\n\n      if (originallyAbove) {\n        const proposedY =\n          parentBox.originalY -\n          labelBox.height +\n          (labelBox.tspanCount > 1\n            ? labelBox.height / (labelBox.tspanCount - 1) / 4\n            : 0);\n        if (proposedY >= cellBounds.minY) newY = proposedY;\n      } else {\n        const proposedY =\n          parentBox.originalY +\n          parentBox.height +\n          (labelBox.tspanCount > 1\n            ? labelBox.height / (labelBox.tspanCount - 1) / 4\n            : 0);\n        if (proposedY + labelBox.height <= cellBounds.maxY) newY = proposedY;\n      }\n\n      return { x: labelBox.originalX, y: newY };\n    }\n\n    /**\n     * Adjust sector label position if overlapping with parent field label\n     * @param {Object} sectorLabel - D3 selection of sector label\n     */\n    function adjustSectorLabel(sectorLabel) {\n      const data = sectorLabel.datum();\n      if (!data || !data.parent) return;\n\n      const parentFieldElement = d3\n        .select(treemap)\n        .selectAll(\".field\")\n        .filter((d) => d?.data?.key === data.parent?.data?.key)\n        .nodes()[0];\n\n      if (!parentFieldElement) return;\n\n      const fieldLabel = d3.select(parentFieldElement);\n      const sectorBox = getLabelBox(sectorLabel);\n      const fieldBox = getLabelBox(fieldLabel);\n      const cellBounds = getCellBounds(data);\n\n      if (\n        !cellBounds ||\n        !sectorBox ||\n        !fieldBox ||\n        sectorBox.width === 0 ||\n        sectorBox.height === 0 ||\n        fieldBox.width === 0 ||\n        fieldBox.height === 0\n      ) {\n        return;\n      }\n\n      if (checkOverlap(sectorBox, fieldBox)) {\n        const newPos = findMinimumMove(sectorBox, fieldBox, cellBounds);\n        sectorLabel.attr(\"transform\", `translate(${newPos.x},${newPos.y})`);\n      }\n    }\n\n    /**\n     * Adjust field label position if overlapping with parent region label\n     * @param {Object} fieldLabel - D3 selection of field label\n     */\n    function adjustFieldLabel(fieldLabel) {\n      const data = fieldLabel.datum();\n      if (!data || !data.parent) return;\n\n      const parentRegionElement = d3\n        .select(treemap)\n        .selectAll(\".region\")\n        .filter((d) => d?.data?.key === data.parent?.data?.key)\n        .nodes()[0];\n\n      if (!parentRegionElement) return;\n\n      const regionLabel = d3.select(parentRegionElement);\n      const fieldBox = getLabelBox(fieldLabel);\n      const regionBox = getLabelBox(regionLabel);\n      const cellBounds = getCellBounds(data);\n\n      if (\n        !cellBounds ||\n        !fieldBox ||\n        !regionBox ||\n        fieldBox.width === 0 ||\n        fieldBox.height === 0 ||\n        regionBox.width === 0 ||\n        regionBox.height === 0\n      ) {\n        return;\n      }\n\n      const regionKey = regionLabel.datum()?.data?.key;\n      if (\n        regionKey &&\n        String(regionKey).match(/[^ ]/) &&\n        checkOverlap(fieldBox, regionBox)\n      ) {\n        const newPos = findMinimumMove(fieldBox, regionBox, cellBounds);\n        fieldLabel.attr(\"transform\", `translate(${newPos.x},${newPos.y})`);\n      }\n    }\n  }\n}\n\nexport default LabelAdjuster;\n","/**\n * Nesting For Voronoi Utility\n *\n * Transforms flat data into a nested hierarchical structure suitable\n * for d3.hierarchy() and voronoi treemap visualization.\n *\n * Creates a 3-level hierarchy: root -> region -> bigCluster -> cluster\n * Each leaf node contains budget values for sizing and references to original data.\n */\n\nimport d3 from './utils/d3-bundle.js';\n\n/**\n * Convert flat data array into nested hierarchy structure for voronoi treemap\n *\n * @param {Object[]} data - Array of data objects with region, bigClusterLabel, clusterLabel, and bubbleSize fields\n * @param {string} [key1='bigClusterLabel'] - Field name for first level grouping (big cluster)\n * @param {string} [key2='clusterLabel'] - Field name for second level grouping (cluster)\n * @returns {Object} Nested hierarchy object with key/values structure for d3.hierarchy\n *\n * @example\n * const data = [\n *   { region: 'A', bigClusterLabel: 'Group1', clusterLabel: 'Item1', bubbleSize: 10 },\n *   { region: 'A', bigClusterLabel: 'Group1', clusterLabel: 'Item2', bubbleSize: 20 }\n * ];\n * const nested = nestingForVoronoi(data);\n * const hierarchy = d3.hierarchy(nested, d => d.values).sum(d => d.budget);\n */\nexport function nestingForVoronoi(\n  data,\n  key1 = \"bigClusterLabel\",\n  key2 = \"clusterLabel\"\n) {\n  // 1. Extract only necessary fields\n  const simpleBudget = data.map((d) => ({\n    [key1]: d[key1],\n    [key2]: d[key2],\n    region: d.region,\n    budget: d.bubbleSize ?? 1\n  }));\n\n  // 2. 3-level grouping with d3.rollups: region -> key1 -> key2\n  const nested = d3.rollups(\n    simpleBudget,\n    (d) => d3.sum(d.map((v) => v.budget)),\n    (d) => d.region,\n    (d) => d[key1],\n    (d) => d[key2]\n  );\n\n  // 3. Helper to convert to dictionary format\n  const makeDictionary = (bc, bcData, region) => {\n    return bcData.map((k) => {\n      const item = {\n        [key1]: bc,\n        [key2]: k[0],\n        budget: k[1] ? k[1] : 1\n      };\n\n      const originalData = data.filter(\n        (c) =>\n          c.region === region &&\n          c[key1] === item[key1] &&\n          c[key2] === item[key2]\n      );\n\n      return {\n        key: k[0],\n        values: [item],\n        data: originalData[0],\n        raw: originalData\n      };\n    });\n  };\n\n  // 4. Generate final hierarchical structure\n  const kv = nested.map(([region, regionData]) => ({\n    key: region,\n    values: regionData.map(([bc, bcData]) => ({\n      key: bc,\n      values: makeDictionary(bc, bcData, region)\n    }))\n  }));\n\n  return {\n    key: \"root_nest\",\n    values: kv.filter((d) => d.key)\n  };\n}\n\nexport default nestingForVoronoi;\n","/**\n * Voronoi Treemap Helpers\n *\n * Static utility methods for voronoi treemap visualization including:\n * - Font scaling functions for label sizing\n * - Color manipulation and hierarchy coloring\n * - Text layout and multiline label rendering\n * - Polygon bounds and position calculations\n * - Number formatting utilities\n * - Custom voronoi algorithm creation\n */\n\nimport d3 from './utils/d3-bundle.js';\n\n/**\n * VoronoiTreemapHelpers - Collection of static helper methods\n *\n * These methods support the main VoronoiTreemap class with calculations\n * for sizing, positioning, coloring, and layout of treemap cells and labels.\n */\nconst VoronoiTreemapHelpers = {\n  // === Font Scale Functions ===\n\n  /**\n   * Calculate font scale based on node value ratio in hierarchy\n   * @param {Object} hierarchy - D3 hierarchy root node\n   * @param {Object} d - Current node\n   * @returns {number} Font scale value (0.3 to 1.5)\n   */\n  fontScale: function (hierarchy, d) {\n    let ratio = (d.value / hierarchy.value) * 100;\n    if (ratio > 30) ratio = 30;\n    if (ratio < 0.2) ratio = 0.2;\n    return d3.scaleLog().domain([0.1, 20]).range([0.3, 1.5])(ratio);\n  },\n\n  /**\n   * Calculate font scale for a specific value (not node-based)\n   * @param {Object} hierarchy - D3 hierarchy root node\n   * @param {string} string - Text string (unused but kept for API compatibility)\n   * @param {number} value - Value to calculate scale for\n   * @returns {number} Font scale value (0.3 to 1.5)\n   */\n  fontScale1: function (hierarchy, string, value) {\n    let ratio = (value / hierarchy.value) * 100;\n    if (ratio > 30) ratio = 30;\n    if (ratio < 0.2) ratio = 0.2;\n    return d3.scaleLog().domain([0.1, 20]).range([0.3, 1.5])(ratio);\n  },\n\n  /**\n   * Calculate secondary font scale (smaller range for sub-labels)\n   * @param {Object} hierarchy - D3 hierarchy root node\n   * @param {Object} d - Current node\n   * @returns {number} Font scale value (0.5 to 0.8)\n   */\n  fontScale2: function (hierarchy, d) {\n    let ratio = (d.value / hierarchy.value) * 100;\n    if (ratio > 5) ratio = 5;\n    if (ratio < 0.1) ratio = 0.1;\n    return d3.scaleLog().domain([0.1, 8]).range([0.5, 0.8])(ratio);\n  },\n\n  /**\n   * Calculate variable font scale for label positioning\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @returns {number} Calculated offset value\n   */\n  varFontScale: function (self, d) {\n    const text = d.data.data.clusterLabel ?? d.data.data.bigClusterLabel;\n    const [cols, rows] = this.multiline(text, true);\n    return d.data.data.clusterLabel\n      ? (this.fontScale2(self.hierarchy, d) * 6 * rows) / 2 + 20\n      : (this.fontScale(self.hierarchy, d) * 30 * rows) / 2 + 8;\n  },\n\n  // === Color Functions ===\n\n  /**\n   * Get HSL color with adjustments\n   * @param {string} color - Base color\n   * @param {number} [h=0] - Hue adjustment\n   * @param {number} [s=0] - Saturation adjustment\n   * @param {number} [l=0] - Lightness adjustment\n   * @returns {string} Hex color string\n   */\n  getHSLColor: function (color, h, s, l) {\n    h = h || 0;\n    s = s || 0;\n    l = l || 0;\n    const hslColor = d3.hsl(color);\n    const lighterColor = hslColor.copy({\n      h: hslColor.h + h,\n      s: hslColor.s + s,\n      l: hslColor.l + l\n    });\n    return lighterColor.formatHex();\n  },\n\n  /**\n   * Color variation with HSL adjustments (alternate parameter order)\n   * @param {string} color - Base color\n   * @param {number} [h=0] - Hue adjustment\n   * @param {number} [l=0] - Lightness adjustment\n   * @param {number} [s=0] - Saturation adjustment\n   * @returns {string} Hex color string\n   */\n  colorVar: function (color, h, l, s) {\n    h = h || 0;\n    l = l || 0;\n    s = s || 0;\n    let c = d3.hsl(color);\n    c.h += h;\n    c.l += l;\n    c.s += s;\n    if (c.l > 0.95) c.l = 0.95;\n    return c.formatHex();\n  },\n\n  /**\n   * Color variation for secondary elements (darker, less saturated)\n   * @param {string} color - Base color\n   * @returns {string} Hex color string\n   */\n  colorVar2: function (color) {\n    let c = d3.hsl(color);\n    c.l = c.l * 0.3;\n    c.s = 0.25;\n    if (c.l > 0.95) c.l = 0.95;\n    if (c.l < 0.1) c.l = 0.1;\n    return c.formatHex();\n  },\n\n  /**\n   * Color variation based on value within domain\n   * @param {string} color - Base color\n   * @param {number[]} vdomain - Value domain array for extent calculation\n   * @param {number} value - Current value\n   * @param {string} desc - Description (unused but kept for API compatibility)\n   * @returns {string} Hex color string\n   */\n  colorvariation: function (color, vdomain, value, desc) {\n    const domain = d3.extent(vdomain);\n    let vScale = d3.scaleLinear().domain(domain).range([0.3, 1]);\n    let c = d3.hsl(color);\n    if (c.l > 0.8) c.l = 0.8;\n    c.l += (0.5 - vScale(value)) * 0.1;\n    if (c.l > 0.9) c.l = 0.9;\n    return c.formatHex();\n  },\n\n  /**\n   * Recursively assign colors to hierarchy nodes based on depth\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} hierarchy - D3 hierarchy node to color\n   */\n  colorHierarchy: function (self, hierarchy) {\n    if (hierarchy.depth === 0) {\n      hierarchy.color = \"#ddd\";\n    } else if (hierarchy.depth === 1) {\n      hierarchy.color = self.regionColor(hierarchy.data.key);\n    } else if (hierarchy.depth === 2) {\n      hierarchy.color = this.colorvariation(\n        hierarchy.parent.color,\n        hierarchy.parent.children.map((d) => d.value),\n        hierarchy.value,\n        hierarchy.depth + hierarchy.data.key\n      );\n    } else if (hierarchy.depth === 3) {\n      hierarchy.color = this.colorvariation(\n        hierarchy.parent.color,\n        hierarchy.parent.parent.children.map((d) => d.value),\n        hierarchy.value,\n        hierarchy.depth + hierarchy.data.key\n      );\n      if (self.params.colorFunc) {\n        const originalData = self.data.filter(\n          (d) =>\n            d.clusterLabel === hierarchy.data.key &&\n            d.bigClusterLabel === hierarchy.parent.data.key\n        );\n        hierarchy.color = self.params.colorFunc(\n          originalData,\n          hierarchy.data.data,\n          hierarchy.color,\n          {\n            parentColor: hierarchy.parent.color,\n            siblings: hierarchy.parent.parent.children.map((d) => d.value),\n            value: hierarchy.value,\n            depth: hierarchy.depth,\n            region: hierarchy.parent.parent\n          }\n        );\n      }\n    }\n    if (hierarchy.children) {\n      hierarchy.children.forEach((child) => this.colorHierarchy(self, child));\n    }\n  },\n\n  // === Text & Label Functions ===\n\n  /**\n   * Convert text to multiline SVG tspan format\n   * @param {string} text - Input text\n   * @param {boolean} [getBoxInfo=false] - If true, return [maxWidth, lineCount] instead of HTML\n   * @returns {string|number[]} HTML string for tspans, or [maxWidth, lineCount] if getBoxInfo is true\n   */\n  multiline: function (text, getBoxInfo) {\n    const inputText = text ? String(text) : \"\";\n    const isLatinText = !/[^A-Za-z0-9\\s\\-.,!?:;@]/.test(inputText);\n    const forcedLineBreaks = inputText.split(\"\\n\");\n    let allLines = [];\n\n    forcedLineBreaks.forEach((line) => {\n      const words = line.split(/[ ,]/);\n      let currentLines = [];\n      let count = 0;\n      let lineCount = 0;\n      currentLines[0] = \"\";\n\n      words.forEach((word) => {\n        if (word.length + count > (isLatinText ? 9 : 7)) {\n          lineCount += 1;\n          count = 0;\n          currentLines[lineCount] = \"\";\n        }\n        currentLines[lineCount] = currentLines[lineCount] + word.trim() + \" \";\n        count += word.length;\n      });\n      const filteredLines = currentLines.filter((d) => d.trim());\n      allLines = allLines.concat(filteredLines);\n    });\n\n    const charWidths = {\n      i: 0.4,\n      j: 0.4,\n      l: 0.4,\n      t: 0.5,\n      f: 0.5,\n      r: 0.6,\n      I: 0.3,\n      1: 0.6,\n      \"!\": 0.3,\n      \"|\": 0.3,\n      \".\": 0.3,\n      \",\": 0.3,\n      \":\": 0.3,\n      \";\": 0.4,\n      w: 1.4,\n      W: 1.6,\n      m: 1.3,\n      M: 1.5,\n      \"@\": 1.4,\n      a: 0.9,\n      e: 0.9,\n      o: 0.9,\n      u: 0.9,\n      n: 0.9,\n      s: 0.8,\n      A: 1.1,\n      E: 1.0,\n      O: 1.2,\n      U: 1.1,\n      N: 1.1,\n      S: 1.0\n    };\n\n    function calculateTextWidth(text) {\n      return Array.from(text).reduce(\n        (width, char) => width + (charWidths[char] || 1.0),\n        0\n      );\n    }\n\n    const lineWidths = allLines.map((line) => {\n      const trimmedLine = line.trim();\n      const isLatinText = !/[^A-Za-z0-9\\s\\-.,!?:;@]/.test(trimmedLine);\n      return isLatinText\n        ? calculateTextWidth(trimmedLine)\n        : trimmedLine.length;\n    });\n    let maxLength = Math.max(...lineWidths);\n\n    if (getBoxInfo) return [maxLength, allLines.length];\n\n    const html = allLines\n      .map(\n        (d, i) => `<tspan x=${-maxLength / 3}em dy=${1}em>${d.trim()}</tspan>`\n      )\n      .join(\"\");\n    return `<tspan x=${0}em y=${-allLines.length / 2}em>${html}</tspan>`;\n  },\n\n  /**\n   * Calculate label height offset based on font size and line count\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @returns {number} Height offset value\n   */\n  getLabelHeightOffset: function (self, d) {\n    const fontSize = this.fontScale(self.hierarchy, d);\n    const [width, lineRows] = this.multiline(d.data.key, true);\n    const boxHeight = fontSize * 8 * (lineRows - 2);\n    return boxHeight;\n  },\n\n  /**\n   * Calculate optimal label position within parent polygon\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @returns {number[]|undefined} [x, y] position or undefined for depth 1 nodes\n   */\n  getLabelPos: function (self, d) {\n    if (d.depth === 1) return;\n    const parentCenter = d.parent.polygon.site;\n    const currentCenter = d.polygon.site;\n    if (d.parent.children.length > 1)\n      return [currentCenter.x, currentCenter.y];\n\n    const diffX = currentCenter.x - parentCenter.x;\n    const diffY = currentCenter.y - parentCenter.y;\n    let offY = 0,\n      offX = 0;\n\n    const fontSize = this.fontScale2(self.hierarchy, d);\n    const [meanWidth, lineRows] = this.multiline(d.data.key, true);\n    const boxHeight = fontSize * 6 * lineRows;\n    const boxWidth = fontSize * 6 * meanWidth;\n    const minOffset = Math.max(18, boxHeight / 2);\n\n    if (Math.abs(diffY) < minOffset) {\n      offY = diffY >= 0 ? minOffset : -minOffset;\n      if (Math.abs(diffX) < boxWidth) {\n        offX = diffX >= 0 ? boxWidth / 2 : -boxWidth / 2;\n      }\n    }\n\n    const parentBounds = this.getPolygonBounds(d.parent.polygon);\n    const proposedX = currentCenter.x + offX;\n    const proposedY = currentCenter.y + offY;\n\n    if (proposedX < parentBounds.minX + boxWidth / 2) {\n      offX = parentBounds.minX + boxWidth / 2 - currentCenter.x;\n    } else if (proposedX > parentBounds.maxX - boxWidth / 2) {\n      offX = parentBounds.maxX - boxWidth / 2 - currentCenter.x;\n    }\n    if (proposedY < parentBounds.minY + boxHeight / 2) {\n      offY = parentBounds.minY + boxHeight / 2 - currentCenter.y;\n    } else if (proposedY > parentBounds.maxY - boxHeight / 2) {\n      offY = parentBounds.maxY - boxHeight / 2 - currentCenter.y;\n    }\n\n    return [currentCenter.x + offX, currentCenter.y + offY];\n  },\n\n  /**\n   * Get bounding box of a polygon\n   * @param {number[][]} polygon - Array of [x, y] coordinate pairs\n   * @returns {Object} { minX, maxX, minY, maxY }\n   */\n  getPolygonBounds: function (polygon) {\n    const xs = polygon.map((point) => point[0]);\n    const ys = polygon.map((point) => point[1]);\n    return {\n      minX: Math.min(...xs),\n      maxX: Math.max(...xs),\n      minY: Math.min(...ys),\n      maxY: Math.max(...ys)\n    };\n  },\n\n  /**\n   * Estimate polygon radius from area\n   * @param {Object} d - Node with polygon data\n   * @returns {number} Estimated radius\n   */\n  estimatePolygonRadius: function (d) {\n    const area = d.polygon.site.originalObject.polygon.area();\n    return Math.sqrt(area / Math.PI);\n  },\n\n  /**\n   * Estimate label width based on font size and text length\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @param {number} [fontMultiplier=1] - Font size multiplier\n   * @returns {number} Estimated width (minimum 60)\n   */\n  estimateLabelWidth: function (self, d, fontMultiplier) {\n    fontMultiplier = fontMultiplier || 1;\n    const fontSize = this.fontScale(self.hierarchy, d) * fontMultiplier;\n    const [maxWidth, lineCount] = this.multiline(d.data.key, true);\n    return Math.max(fontSize * 16 * maxWidth * 0.8, 60);\n  },\n\n  /**\n   * Estimate label height based on font size and line count\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @param {number} [fontMultiplier=1] - Font size multiplier\n   * @returns {number} Estimated height (minimum 40)\n   */\n  estimateLabelHeight: function (self, d, fontMultiplier) {\n    fontMultiplier = fontMultiplier || 1;\n    const fontSize = this.fontScale(self.hierarchy, d) * fontMultiplier;\n    const [maxWidth, lineCount] = this.multiline(d.data.key, true);\n    return Math.max(fontSize * 16 * lineCount * 1.5, 40);\n  },\n\n  /**\n   * Create context object for custom label renderers\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @param {number} depth - Depth level (1 or 2)\n   * @returns {Object} Context object with label rendering information\n   */\n  createLabelContext: function (self, d, depth) {\n    return {\n      key: d.data.key,\n      value: d.value,\n      depth: d.depth,\n      data: d.data.values[0]?.data,\n      ratio: d.value / self.totalValue,\n      percentText: d3.format(\".0%\")(d.value / self.totalValue),\n      color: d.color,\n      parentColor: d.parent?.color,\n      darkerColor: this.getHSLColor(d.color, 0, -0.1, -0.2),\n      lighterColor: this.getHSLColor(d.color, 0, 0.1, 0.1),\n      fontSize:\n        depth === 1\n          ? this.fontScale(self.hierarchy, d) * 1.15\n          : this.fontScale(self.hierarchy, d),\n      centerX: d.polygon.site.x,\n      centerY: d.polygon.site.y,\n      polygon: d.polygon,\n      parent: d.parent\n        ? {\n            key: d.parent.data.key,\n            value: d.parent.value,\n            color: d.parent.color\n          }\n        : null,\n      children: d.children\n        ? d.children.map((c) => ({\n            key: c.data.key,\n            value: c.value,\n            color: c.color\n          }))\n        : null,\n      totalValue: self.totalValue,\n      formatNumber: (n) => this.bigFormat(n),\n      formatPercent: (n) => d3.format(\".1%\")(n)\n    };\n  },\n\n  // === Number Format Functions ===\n\n  /**\n   * Format large numbers with Korean units (조, 억, 만)\n   * @param {number} n - Number to format\n   * @returns {string} Formatted string with Korean number units\n   */\n  bigFormat: function (n) {\n    const 조 = n > 10 ** 12 ? Math.floor(n / 10 ** 12) % 10 ** 4 : 0;\n    const 억 = n > 10 ** 8 ? Math.round(n / 10 ** 8) % 10 ** 4 : 0;\n    const 만 = parseInt(n / 10 ** 4) % 10 ** 4;\n\n    return (\n      (조 >= 1 ? d3.format(\",.0f\")(조) + \"조 \" : \" \") +\n      (억 >= 1 ? d3.format(\",.0f\")(억) + \"억 \" : \" \") +\n      (n < 10 ** 10 && 만 >= 1 ? d3.format(\",.0f\")(만) + \"만 \" : \" \") +\n      (n < 10 ** 4 ? d3.format(\",.0f\")(Math.round(n)) : \" \")\n    );\n  },\n\n  // === Custom Voronoi Algorithm ===\n\n  /**\n   * Create a custom voronoi treemap algorithm with initial position support\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {boolean} [debug=false] - Enable debug mode\n   * @returns {Function} Voronoi treemap algorithm function\n   */\n  createCustomVoronoiAlgorithm: function (self, debug) {\n    debug = debug || false;\n    const DEFAULT_CONVERGENCE_RATIO = 0.01;\n    const DEFAULT_MAX_ITERATION_COUNT = 50;\n    const DEFAULT_MIN_WEIGHT_RATIO = 0.01;\n    const DEFAULT_PRNG = Math.random;\n\n    var clip = [\n      [0, 0],\n      [0, 1],\n      [1, 1],\n      [1, 0]\n    ];\n    var extent = [\n      [0, 0],\n      [1, 1]\n    ];\n    var size = [1, 1];\n    var convergenceRatio = DEFAULT_CONVERGENCE_RATIO;\n    var maxIterationCount = DEFAULT_MAX_ITERATION_COUNT;\n    var minWeightRatio = DEFAULT_MIN_WEIGHT_RATIO;\n    var prng = DEFAULT_PRNG;\n    var initialPositions = {};\n\n    var unrelevantButNeedeData = [{ weight: 1 }, { weight: 1 }];\n    var _convenientReusableVoronoiMapSimulation = d3\n      .voronoiMapSimulation(unrelevantButNeedeData)\n      .stop();\n\n    const helpers = this;\n\n    const _voronoiTreemap = function (rootNode) {\n      recurse(clip, rootNode);\n    };\n\n    _voronoiTreemap.convergenceRatio = function (_) {\n      return arguments.length\n        ? ((convergenceRatio = _), _voronoiTreemap)\n        : convergenceRatio;\n    };\n    _voronoiTreemap.maxIterationCount = function (_) {\n      return arguments.length\n        ? ((maxIterationCount = _), _voronoiTreemap)\n        : maxIterationCount;\n    };\n    _voronoiTreemap.minWeightRatio = function (_) {\n      return arguments.length\n        ? ((minWeightRatio = _), _voronoiTreemap)\n        : minWeightRatio;\n    };\n    _voronoiTreemap.clip = function (_) {\n      if (!arguments.length) return clip;\n      _convenientReusableVoronoiMapSimulation.clip(_);\n      clip = _convenientReusableVoronoiMapSimulation.clip();\n      extent = _convenientReusableVoronoiMapSimulation.extent();\n      size = _convenientReusableVoronoiMapSimulation.size();\n      return _voronoiTreemap;\n    };\n    _voronoiTreemap.extent = function (_) {\n      if (!arguments.length) return extent;\n      _convenientReusableVoronoiMapSimulation.extent(_);\n      clip = _convenientReusableVoronoiMapSimulation.clip();\n      extent = _convenientReusableVoronoiMapSimulation.extent();\n      size = _convenientReusableVoronoiMapSimulation.size();\n      return _voronoiTreemap;\n    };\n    _voronoiTreemap.size = function (_) {\n      if (!arguments.length) return size;\n      _convenientReusableVoronoiMapSimulation.size(_);\n      clip = _convenientReusableVoronoiMapSimulation.clip();\n      extent = _convenientReusableVoronoiMapSimulation.extent();\n      size = _convenientReusableVoronoiMapSimulation.size();\n      return _voronoiTreemap;\n    };\n    _voronoiTreemap.prng = function (_) {\n      return arguments.length ? ((prng = _), _voronoiTreemap) : prng;\n    };\n    _voronoiTreemap.initialPositions = function (_) {\n      return arguments.length\n        ? ((initialPositions = _), _voronoiTreemap)\n        : initialPositions;\n    };\n\n    const recurse = function (clippingPolygon, node) {\n      var simulation;\n      node.polygon = clippingPolygon;\n\n      if (node.height != 0) {\n        simulation = d3\n          .voronoiMapSimulation(node.children)\n          .clip(clippingPolygon)\n          .weight((d) => d.value)\n          .convergenceRatio(convergenceRatio)\n          .maxIterationCount(maxIterationCount)\n          .minWeightRatio(minWeightRatio)\n          .prng(prng)\n          .initialPosition(\n            helpers.createInitialPositioner(self, initialPositions, debug)\n          )\n          .stop();\n\n        var state = simulation.state();\n        while (!state.ended) {\n          simulation.tick();\n          state = simulation.state();\n        }\n\n        state.polygons.forEach(function (cp) {\n          recurse(cp, cp.site.originalObject.data.originalData);\n        });\n      }\n    };\n\n    return _voronoiTreemap;\n  },\n\n  /**\n   * Create initial position function for voronoi simulation\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object[]} initialPositions - Array of initial position objects\n   * @param {boolean} [debug=false] - Enable debug mode\n   * @returns {Function} Position function for voronoi simulation\n   */\n  createInitialPositioner: function (self, initialPositions, debug) {\n    debug = debug || false;\n    var clippingPolygon, extent, minX, maxX, minY, maxY, dx, dy;\n\n    function updateInternals() {\n      minX = extent[0][0];\n      maxX = extent[1][0];\n      minY = extent[0][1];\n      maxY = extent[1][1];\n      dx = maxX - minX;\n      dy = maxY - minY;\n    }\n\n    function findNodeInitialPosition(node, initialPositions) {\n      return initialPositions.find(\n        (pos) => pos.depth === node.depth && pos.key === node.data.key\n      );\n    }\n\n    function getSiblingInitialPositions(siblings, initialPositions) {\n      return siblings\n        .map((sibling) => findNodeInitialPosition(sibling, initialPositions))\n        .filter((pos) => pos !== undefined);\n    }\n\n    function getPolygonAngles(clippingPolygon) {\n      const polygonXExtent = d3.extent(clippingPolygon, (d) => d[0]);\n      const polygonYExtent = d3.extent(clippingPolygon, (d) => d[1]);\n\n      return clippingPolygon\n        .map((point) => {\n          const x = d3.scaleLinear().domain(polygonXExtent).range([-1, 1])(\n            point[0]\n          );\n          const y = d3.scaleLinear().domain(polygonYExtent).range([-1, 1])(\n            point[1]\n          );\n          const angle = Math.atan2(y, x);\n          return {\n            angle: angle < 0 ? angle + 2 * Math.PI : angle,\n            point: point,\n            x: x,\n            y: y\n          };\n        })\n        .sort((a, b) => a.angle - b.angle);\n    }\n\n    function mapPointToPolygon(x, y, polygonAngles, clippingPolygon) {\n      const angle = Math.atan2(y, x);\n      const normalizedAngle = angle < 0 ? angle + 2 * Math.PI : angle;\n\n      let startAngle, endAngle, startPoint, endPoint;\n      for (let i = 0; i < polygonAngles.length; i++) {\n        if (normalizedAngle <= polygonAngles[i].angle) {\n          startAngle =\n            i === 0\n              ? polygonAngles[polygonAngles.length - 1].angle\n              : polygonAngles[i - 1].angle;\n          endAngle = polygonAngles[i].angle;\n          startPoint =\n            i === 0\n              ? polygonAngles[polygonAngles.length - 1]\n              : polygonAngles[i - 1];\n          endPoint = polygonAngles[i];\n          break;\n        }\n      }\n\n      if (startAngle === undefined) {\n        startAngle = polygonAngles[polygonAngles.length - 1].angle;\n        endAngle = polygonAngles[0].angle + 2 * Math.PI;\n        startPoint = polygonAngles[polygonAngles.length - 1];\n        endPoint = polygonAngles[0];\n      }\n\n      const t = (normalizedAngle - startAngle) / (endAngle - startAngle);\n      const edgeX = startPoint.x + t * (endPoint.x - startPoint.x);\n      const edgeY = startPoint.y + t * (endPoint.y - startPoint.y);\n\n      const distanceToPoint = Math.sqrt(x * x + y * y);\n      const maxDistance = Math.sqrt(2);\n      const ratio = (distanceToPoint / maxDistance) * 0.9;\n\n      const mappedX = ratio * edgeX;\n      const mappedY = ratio * edgeY;\n\n      const polygonXExtent = d3.extent(clippingPolygon, (d) => d[0]);\n      const polygonYExtent = d3.extent(clippingPolygon, (d) => d[1]);\n\n      const finalX = d3.scaleLinear().domain([-1, 1]).range(polygonXExtent)(\n        mappedX\n      );\n      const finalY = d3.scaleLinear().domain([-1, 1]).range(polygonYExtent)(\n        mappedY\n      );\n\n      return [finalX, finalY, normalizedAngle, ratio, [x, y]];\n    }\n\n    const _random = function (d, i, arr, voronoiMapSimulation) {\n      var shouldUpdateInternals = false;\n      if (clippingPolygon !== voronoiMapSimulation.clip()) {\n        clippingPolygon = voronoiMapSimulation.clip();\n        extent = voronoiMapSimulation.extent();\n        shouldUpdateInternals = true;\n      }\n      if (shouldUpdateInternals) {\n        updateInternals();\n      }\n\n      if (d.depth === 0) {\n        return [(minX + maxX) / 2, (minY + maxY) / 2];\n      }\n\n      const parent = d.parent || arr[0].parent;\n      const siblings = parent ? parent.children : arr;\n      const siblingInitialPositions = getSiblingInitialPositions(\n        siblings,\n        initialPositions\n      );\n\n      if (siblingInitialPositions.length > 0) {\n        const siblingXExtent = d3.extent(siblingInitialPositions, (d) => d.x);\n        const siblingYExtent = d3.extent(siblingInitialPositions, (d) => d.y);\n        const nodeInitialPosition = findNodeInitialPosition(\n          d,\n          initialPositions\n        );\n\n        if (nodeInitialPosition) {\n          const x = nodeInitialPosition.x * self.width;\n          const y = nodeInitialPosition.y * self.height;\n\n          if (d3.polygonContains(clippingPolygon, [x, y])) {\n            return [x, y];\n          }\n\n          const [mappedX, mappedY] = mapPointToPolygon(\n            d3.scaleLinear().domain(siblingXExtent).range([-1, 1])(\n              nodeInitialPosition.x\n            ),\n            d3.scaleLinear().domain(siblingYExtent).range([-1, 1])(\n              nodeInitialPosition.y\n            ),\n            getPolygonAngles(clippingPolygon),\n            clippingPolygon\n          );\n\n          return [mappedX, mappedY];\n        }\n      }\n\n      // Fallback: random position\n      let x, y;\n      do {\n        x = minX + dx * voronoiMapSimulation.prng()();\n        y = minY + dy * voronoiMapSimulation.prng()();\n      } while (!d3.polygonContains(clippingPolygon, [x, y]));\n\n      return [x, y];\n    };\n\n    return _random;\n  }\n};\n\nexport { VoronoiTreemapHelpers };\nexport default VoronoiTreemapHelpers;\n","/**\n * VoronoiTreemap\n *\n * Main class for creating voronoi treemap visualizations.\n * Renders hierarchical data as organic, pebble-like cells using\n * D3.js and voronoi treemap algorithms.\n *\n * Features:\n * - Hierarchical voronoi treemap layout\n * - Customizable colors, labels, and sizing\n * - Interactive click and hover events\n * - Pebble-style rounded outlines\n * - Label collision detection and adjustment\n * - Region position control for deterministic layouts\n */\n\nimport d3 from './utils/d3-bundle.js';\nimport { PebbleRenderer } from './PebbleRenderer.js';\nimport { LabelAdjuster } from './LabelAdjuster.js';\nimport { nestingForVoronoi } from './nestingForVoronoi.js';\nimport VoronoiTreemapHelpers from './VoronoiTreemapHelpers.js';\n\n/**\n * Escape a string for use in CSS selectors\n * @param {string} str - String to escape\n * @returns {string} Escaped string safe for CSS selectors\n */\nfunction escapeCSSSelector(str) {\n  if (!str) return '';\n  return str.replace(/[!\"#$%&'()*+,./:;<=>?@[\\\\\\]^`{|}~\\n\\r\\t]/g, '\\\\$&');\n}\n\n/**\n * VoronoiTreemap - Main visualization class\n *\n * @example\n * const treemap = new VoronoiTreemap();\n * const svg = treemap.render(data, {\n *   width: 800,\n *   height: 600,\n *   maptitle: 'My Treemap'\n * });\n * document.body.appendChild(svg);\n */\nclass VoronoiTreemap {\n  constructor() {\n    this.margin = { top: 50, right: 50, bottom: 50, left: 50 };\n    this.svg = null;\n    this.data = null;\n    this.hierarchy = null;\n    this.allNodes = null;\n    this._pebbleRenderer = null;\n    this._labelAdjuster = null;\n  }\n\n  // === Default Color Palette ===\n  static get DEFAULT_COLORS() {\n    return \"#afc7dd,#ffe9a9,#f69f8f,#b4c8af,#e9e4d6,#bed1d8,#f8dba1,#fcbc8b,#d7e0c4,#c5b5a6,#b5ccc1,#e9bfb4,#e9f0f6,#fffefb,#fce0db,#e1e9df,#f1f5f7,#fef8ed,#feeada,#fbfcf9,#e5ded7,#e5edea,#fbf5f3,#96b6d3,#ffdf85,#f3836e,#a0b99a,#ddd4be,#a7c1cb,#f5cf80,#fba868,#c7d4ac,#b7a490,#a0bdb0,#e1a799,#d7e3ee,#fff7e1,#facbc3,#d3dfd0,#fdfcfa,#e1eaed,#fcefd5,#fddcc2,#f0f3e9,#dbd2c8,#d6e3dd,#f6e4df,#dee8f1,#fffaeb,#fbd4cc,#d9e3d6,#e7eef1,#fcf3df,#fee1cc,#f4f7ef,#dfd7ce,#dce7e2,#f8ebe7,#e5edf4,#fffdf5,#fcdcd6,#dfe7dc,#eef3f5,#fdf6e8,#fee7d6,#f9faf6,#e3dcd4,#e2ebe7,#faf1ef,#d0b7ba,#b8cec4,#d2b6b6,#b6bdd6,#d9b8b7,#ded5b6,#bac2d7,#c8d5be,#e3bfb7,#f9dfb3,#eac2b8,#c1d3da,#ddc7c1,#d9e2c7,#cfdad5,#eecdc1,#ccdddf,#c7d7e6,#ded6cf,#e7d1cb,#ced9e5,#eedbc8,#d7e3e2,#e3ead2,#ecdcd2,#d9e0e5,#efe1d2,#ebdad7,#eed6da,#e1e6de,#dde4e8,#eee1d8,#f5e8d7,#f1e6dd,#f5e8de,#f3e7e1,#f5eee1,#f5f2ec\".split(\n      \",\"\n    );\n  }\n\n  // === Default Options ===\n  static get DEFAULT_OPTIONS() {\n    return {\n      width: 500,\n      height: 300,\n      maptitle: \"\",\n      caption: \"\",\n      clickFunc: () => {},\n      colorFunc: null,\n      sizeLimit: 1000,\n      ratioLimit: 0,\n      pieSize: 1,\n      colors: VoronoiTreemap.DEFAULT_COLORS,\n      seedRandom: 10,\n      showRegion: false,\n      showPercent: false,\n      underLabel: false,\n      regionPositions: null,\n      forceNodeFunc: null,\n      debug: false,\n      pebbleRound: 25,\n      pebbleWidth: 3,\n      regionColors: [],\n      // Custom label renderer options\n      regionLabelRenderer: null, // (datum, defaultHtml, context) => HTML string\n      bigClusterLabelRenderer: null // (datum, defaultHtml, context) => HTML string\n    };\n  }\n\n  // === Getter for post-processing modules ===\n  get pebbleRenderer() {\n    if (!this._pebbleRenderer) {\n      this._pebbleRenderer = new PebbleRenderer(d3);\n    }\n    return this._pebbleRenderer;\n  }\n\n  get labelAdjuster() {\n    if (!this._labelAdjuster) {\n      this._labelAdjuster = new LabelAdjuster(d3);\n    }\n    return this._labelAdjuster;\n  }\n\n  // === Public Methods ===\n\n  /**\n   * Render chart - returns SVG element\n   * @param {Object[]} data - Data array to visualize\n   * @param {Object} [options] - Rendering options\n   * @returns {SVGSVGElement} - Generated SVG element\n   */\n  render(data, options = {}) {\n    this.params = { ...VoronoiTreemap.DEFAULT_OPTIONS, ...options };\n    this.data = data;\n\n    this._setupSVG();\n    this._prepareData();\n    this._setupGroups();\n    this._drawTitleAndCaption();\n    this._createRegionColorScale();\n    this._computeLayout();\n    this._drawCells();\n    this._drawLabels();\n    this._applyPostEffects();\n\n    return this.svg.node();\n  }\n\n  /**\n   * Update chart (data only)\n   * @param {Object[]} newData - New data\n   * @returns {SVGSVGElement}\n   */\n  update(newData) {\n    return this.render(newData, this.params);\n  }\n\n  // === 1. Initial Setup Methods ===\n\n  _setupSVG() {\n    // Create independent SVG element (no container needed)\n    this.svg = d3\n      .create(\"svg\")\n      .attr(\"width\", this.params.width + this.margin.left + this.margin.right)\n      .attr(\n        \"height\",\n        this.params.height + this.margin.top + this.margin.bottom\n      );\n\n    this.svg\n      .append(\"rect\")\n      .attr(\"width\", \"100%\")\n      .attr(\"height\", \"100%\")\n      .style(\"fill\", \"#fff\");\n\n    this.width = this.params.width * Math.sqrt(this.params.pieSize);\n    this.height = this.width * (this.params.height / this.params.width);\n  }\n\n  _prepareData() {\n    // Use external nestingForVoronoi function\n    const nested = nestingForVoronoi(\n      this.data,\n      \"bigClusterLabel\",\n      \"clusterLabel\"\n    );\n\n    this.hierarchy = d3.hierarchy(nested, (d) => d.values).sum((d) => d.budget);\n\n    this.totalValue = this.hierarchy.value;\n  }\n\n  _setupGroups() {\n    this.chartGroup = this.svg\n      .append(\"g\")\n      .attr(\"transform\", `translate(${this.margin.left},${this.margin.top})`);\n\n    this.voronoiGroup = this.chartGroup.append(\"g\").attr(\"class\", \"cell\");\n    this.labelsGroup = this.chartGroup.append(\"g\").attr(\"class\", \"labels\");\n    this.popLabelsGroup = this.chartGroup.append(\"g\").attr(\"class\", \"pop\");\n    this.bigLabelsGroup = this.chartGroup.append(\"g\").attr(\"class\", \"label1\");\n    this.percentLabelsGroup = this.chartGroup\n      .append(\"g\")\n      .attr(\"class\", \"percent\");\n    this.regionLabelsGroup = this.chartGroup\n      .append(\"g\")\n      .attr(\"class\", \"region\");\n  }\n\n  _drawTitleAndCaption() {\n    this.svg\n      .append(\"g\")\n      .append(\"text\")\n      .attr(\"class\", \"title\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"font-size\", \"22\")\n      .attr(\"font-weight\", \"600\")\n      .attr(\n        \"transform\",\n        `translate(${this.margin.left + this.width / 2},${\n          this.margin.top - 15\n        })`\n      )\n      .html(this.params.maptitle);\n\n    this.svg\n      .append(\"g\")\n      .append(\"text\")\n      .attr(\"class\", \"caption\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"font-size\", \"15\")\n      .attr(\"font-weight\", \"400\")\n      .attr(\"fill\", \"#888\")\n      .attr(\n        \"transform\",\n        `translate(${this.margin.left + this.width / 2},${\n          this.margin.top + this.height + 30\n        })`\n      )\n      .html(this.params.caption);\n  }\n\n  _createRegionColorScale() {\n    const categories = Array.from(new Set(this.data.map((d) => d.region)));\n    const { regionColors, colors: cellColors } = this.params;\n    const regionColorKeys = regionColors.map((d) => d.key);\n    const regionColorValues = regionColors.map((d) => d.color);\n\n    let colorMapping = {};\n\n    categories.forEach((key, i) => {\n      colorMapping[key] = cellColors[i % cellColors.length];\n    });\n\n    regionColorKeys.forEach((key, i) => {\n      colorMapping[key] = regionColorValues[i];\n    });\n\n    this.regionColor = d3\n      .scaleOrdinal()\n      .domain(Object.keys(colorMapping))\n      .range(Object.values(colorMapping));\n  }\n\n  // === 2. Layout Calculation Methods ===\n\n  _computeLayout() {\n    const ellipse = d3.range(100).map((i) => {\n      let x = Math.cos((i / 50) * Math.PI);\n      const max = 0.92;\n      if (x > max) x = max + (x - max) * 0.5;\n      if (x < -max) x = -max + (x + max) * 0.5;\n      x = x / 0.94;\n      const y = Math.sin((i / 25) * Math.PI);\n      return [\n        (this.width * (1 + 0.99 * x)) / 2,\n        (this.height * (1 + 0.99 * y)) / 2\n      ];\n    });\n\n    const seed = new Math.seedrandom(this.params.seedRandom);\n\n    let voronoiTreeMap = d3.voronoiTreemap().prng(seed).clip(ellipse);\n    voronoiTreeMap(this.hierarchy);\n\n    if (this.params.regionPositions && this.params.regionPositions !== 'auto') {\n      const mergedPositions = this._normalizePositions(\n        this.params.regionPositions\n      );\n\n      const modifiedVoronoiTreeMap =\n        VoronoiTreemapHelpers.createCustomVoronoiAlgorithm(\n          this,\n          this.params.debug\n        )\n          .size([this.width, this.height])\n          .clip(ellipse)\n          .prng(seed)\n          .initialPositions(mergedPositions);\n\n      modifiedVoronoiTreeMap(this.hierarchy);\n    }\n\n    VoronoiTreemapHelpers.colorHierarchy(this, this.hierarchy);\n\n    this.allNodes = this.hierarchy\n      .descendants()\n      .sort((a, b) => b.depth - a.depth)\n      .map((d, i) => Object.assign({}, d, { id: i }));\n  }\n\n  _normalizePositions(regionPositions) {\n    const result = [];\n    const hierarchyNodes = this.hierarchy.descendants();\n\n    // depth 1: Normalize based on overall extent\n    const depth1 = regionPositions.filter((p) => p.depth === 1);\n    if (depth1.length > 0) {\n      const xExtent = d3.extent(depth1, (p) => p.x);\n      const yExtent = d3.extent(depth1, (p) => p.y);\n\n      const xScale =\n        xExtent[0] === xExtent[1]\n          ? () => 0.5\n          : d3.scaleLinear().domain(xExtent).range([0.15, 0.85]);\n      const yScale =\n        yExtent[0] === yExtent[1]\n          ? () => 0.5\n          : d3.scaleLinear().domain(yExtent).range([0.15, 0.85]);\n\n      depth1.forEach((pos) => {\n        result.push({ ...pos, x: xScale(pos.x), y: yScale(pos.y) });\n      });\n    }\n\n    // depth 2, 3: Find parent in hierarchy and normalize among siblings\n    [2, 3].forEach((depth) => {\n      const depthPositions = regionPositions.filter((p) => p.depth === depth);\n      if (depthPositions.length === 0) return;\n\n      // Find parent groups for nodes at this depth\n      const nodesAtDepth = hierarchyNodes.filter((n) => n.depth === depth);\n      const byParent = d3.group(nodesAtDepth, (n) => n.parent?.data?.key);\n\n      byParent.forEach((siblings, parentKey) => {\n        // Find regionPositions for these siblings\n        const siblingKeys = new Set(siblings.map((s) => s.data.key));\n        const siblingPositions = depthPositions.filter((p) =>\n          siblingKeys.has(p.key)\n        );\n\n        if (siblingPositions.length === 0) return;\n\n        const xExtent = d3.extent(siblingPositions, (p) => p.x);\n        const yExtent = d3.extent(siblingPositions, (p) => p.y);\n\n        const xScale =\n          xExtent[0] === xExtent[1]\n            ? () => 0.5\n            : d3.scaleLinear().domain(xExtent).range([0.15, 0.85]);\n        const yScale =\n          yExtent[0] === yExtent[1]\n            ? () => 0.5\n            : d3.scaleLinear().domain(yExtent).range([0.15, 0.85]);\n\n        siblingPositions.forEach((pos) => {\n          result.push({ ...pos, x: xScale(pos.x), y: yScale(pos.y) });\n        });\n      });\n    });\n\n    return result;\n  }\n\n  // === 3. Visualization Element Drawing Methods ===\n\n  _drawCells() {\n    const { clickFunc } = this.params;\n    const self = this;\n\n    this.voronoiGroup\n      .selectAll(\"path\")\n      .data(this.allNodes)\n      .enter()\n      .append(\"path\")\n      .attr(\"d\", (d) => \"M\" + d.polygon.join(\"L\") + \"Z\")\n      .style(\"fill\", (d) => d.color ?? d.parent.color)\n      .attr(\"class\", (d) => `regionArea${d.depth} area-${d.id}`)\n      .style(\"fill-opacity\", (d) => (d.depth === 3 ? 1 : 0))\n      .attr(\"pointer-events\", (d) => (d.depth === 3 ? \"all\" : \"none\"))\n      .on(\"click\", function (e, d) {\n        let area = self.voronoiGroup.select(`.area-${d.id}`);\n        const clicked = area.attr(\"class\").match(\"clicked\");\n        self.voronoiGroup.select(`.clicked`).classed(\"clicked\", false);\n        area.classed(\"clicked\", !clicked);\n        clickFunc(clicked ? \"\" : { ...d.data, event: e, d, clickArea: area });\n      })\n      .on(\"mouseenter\", function (e, d) {\n        const label1 = self.bigLabelsGroup.select(\n          `[data-bigCluster=\"${escapeCSSSelector(d.data.data.bigClusterLabel)}\"]`\n        );\n        label1.attr(\"opacity\", 1);\n\n        const label = self.labelsGroup.select(\n          `[data-cluster=\"${escapeCSSSelector(d.data.data.clusterLabel)}\"]`\n        );\n        label.attr(\"opacity\", 1);\n\n        let area = self.voronoiGroup.select(`.area-${d.id}`);\n        area.classed(\"highlite\", true);\n      })\n      .on(\"mouseleave\", function (e, d) {\n        const label1 = self.bigLabelsGroup.select(\n          `[data-bigCluster=\"${escapeCSSSelector(d.data.data.bigClusterLabel)}\"]`\n        );\n        label1.attr(\"opacity\", (d) =>\n          label1.attr(\"data-ratio\") >= self.params.ratioLimit ? 1 : 0\n        );\n\n        const label = self.labelsGroup.select(\n          `[data-cluster=\"${escapeCSSSelector(d.data.data.clusterLabel)}\"]`\n        );\n        label.attr(\"opacity\", (d) =>\n          label.attr(\"data-ratio\") >= self.params.ratioLimit ? 1 : 0\n        );\n\n        let area = self.voronoiGroup.select(`.area-${d.id}`);\n        area.classed(\"highlite\", false);\n      });\n  }\n\n  _drawLabels() {\n    this._drawRegionLabels();\n    this._drawBigClusterLabels();\n    this._drawPercentLabels();\n    this._drawSectorLabels();\n    this._drawPopLabels();\n  }\n\n  _drawRegionLabels() {\n    const { showRegion, regionLabelRenderer } = this.params;\n    const self = this;\n\n    const regionNodes = this.allNodes.filter((d) => d.depth === 1);\n\n    // If custom renderer exists, use foreignObject\n    if (regionLabelRenderer) {\n      this.regionLabelsGroup\n        .selectAll(\"foreignObject\")\n        .data(regionNodes)\n        .enter()\n        .append(\"foreignObject\")\n        .attr(\"class\", \"region-label-foreign\")\n        .attr(\"data-region\", (d) => d.data.key)\n        .attr(\"width\", (d) => {\n          const bounds = VoronoiTreemapHelpers.getPolygonBounds(d.polygon);\n          const width = bounds.maxX - bounds.minX;\n          return width * 0.6;\n        })\n        .attr(\"height\", (d) =>\n          VoronoiTreemapHelpers.estimateLabelHeight(this, d, 1.3)\n        )\n        .attr(\"x\", (d) => {\n          const bounds = VoronoiTreemapHelpers.getPolygonBounds(d.polygon);\n          const width = bounds.maxX - bounds.minX;\n          return d.polygon.site.x - (width * 0.6) / 2;\n        })\n        .attr(\n          \"y\",\n          (d) =>\n            d.polygon.site.y -\n            VoronoiTreemapHelpers.estimateLabelHeight(this, d, 1.3) * 0.4 +\n            VoronoiTreemapHelpers.getLabelHeightOffset(this, d)\n        )\n        .style(\"opacity\", showRegion ? 1 : 0)\n        .style(\"pointer-events\", \"none\")\n        .style(\"overflow\", \"visible\")\n        .append(\"xhtml:div\")\n        .style(\"width\", \"100%\")\n        .style(\"height\", \"100%\")\n        .style(\"display\", \"flex\")\n        .style(\"align-items\", \"center\")\n        .style(\"justify-content\", \"center\")\n        .html((d) => {\n          const defaultHtml = VoronoiTreemapHelpers.multiline(d.data.key);\n          const context = VoronoiTreemapHelpers.createLabelContext(this, d, 1);\n          return regionLabelRenderer(d, defaultHtml, context);\n        });\n    } else {\n      // Default text rendering\n      this.regionLabelsGroup\n        .selectAll(\"text\")\n        .data(regionNodes)\n        .enter()\n        .append(\"text\")\n        .attr(\"class\", \"region\")\n        .attr(\"text-anchor\", \"start\")\n        .attr(\"ratio\", (d) => d.value / d.parent.value)\n        .style(\n          \"font-size\",\n          (d) =>\n            VoronoiTreemapHelpers.fontScale(this.hierarchy, d) * 1.15 + \"em\"\n        )\n        .style(\"fill-opacity\", showRegion ? 1 : 0)\n        .style(\"stroke-opacity\", showRegion ? 0.85 : 0)\n        .style(\n          \"stroke\",\n          (d) => `${VoronoiTreemapHelpers.getHSLColor(d.color, 0, -0.05, -0.2)}`\n        )\n        .attr(\"paint-order\", \"stroke\")\n        .attr(\n          \"transform\",\n          (d) =>\n            `translate(${[\n              d.polygon.site.x,\n              d.polygon.site.y +\n                VoronoiTreemapHelpers.getLabelHeightOffset(this, d)\n            ]})`\n        )\n        .html((d) => VoronoiTreemapHelpers.multiline(d.data.key));\n    }\n  }\n\n  _drawBigClusterLabels() {\n    const { ratioLimit, bigClusterLabelRenderer } = this.params;\n    const self = this;\n\n    const bigClusterNodes = this.allNodes.filter((d) => d.depth === 2);\n\n    // If custom renderer exists, use foreignObject\n    if (bigClusterLabelRenderer) {\n      this.bigLabelsGroup\n        .selectAll(\"foreignObject\")\n        .data(bigClusterNodes)\n        .enter()\n        .append(\"foreignObject\")\n        .attr(\"class\", \"bigcluster-label-foreign\")\n        .attr(\"data-bigCluster\", (d) => d.data.key)\n        .attr(\"data-value\", (d) => d.value)\n        .attr(\"data-ratio\", (d) => d.value / this.totalValue)\n\n        .attr(\"width\", (d) => {\n          const bounds = VoronoiTreemapHelpers.getPolygonBounds(d.polygon);\n          const width = bounds.maxX - bounds.minX;\n          return width * 0.6;\n        })\n        .attr(\"height\", (d) =>\n          VoronoiTreemapHelpers.estimateLabelHeight(this, d, 1.2)\n        )\n        .attr(\"x\", (d) => {\n          const bounds = VoronoiTreemapHelpers.getPolygonBounds(d.polygon);\n          const width = bounds.maxX - bounds.minX;\n          return d.polygon.site.x - (width * 0.6) / 2;\n        })\n        .attr(\n          \"y\",\n          (d) =>\n            d.polygon.site.y -\n            VoronoiTreemapHelpers.estimateLabelHeight(this, d, 1.2) * 0.45 +\n            VoronoiTreemapHelpers.getLabelHeightOffset(this, d)\n        )\n        .attr(\"opacity\", (d) =>\n          d.value / this.totalValue >= ratioLimit ? 1 : 0\n        )\n        .style(\"pointer-events\", \"none\")\n        .style(\"overflow\", \"visible\")\n        .append(\"xhtml:div\")\n        .style(\"width\", \"100%\")\n        .style(\"height\", \"100%\")\n        .style(\"display\", \"flex\")\n        .style(\"align-items\", \"center\")\n        .style(\"justify-content\", \"center\")\n        .html((d) => {\n          const defaultHtml = VoronoiTreemapHelpers.multiline(d.data.key);\n          const context = VoronoiTreemapHelpers.createLabelContext(this, d, 2);\n          return bigClusterLabelRenderer(d, defaultHtml, context);\n        });\n    } else {\n      // Default text rendering\n      this.bigLabelsGroup\n        .selectAll(\"text\")\n        .data(bigClusterNodes)\n        .enter()\n        .append(\"text\")\n        .attr(\"class\", \"field\")\n        .attr(\"data-bigCluster\", (d) => d.data.key)\n        .attr(\"text-anchor\", \"start\")\n        .attr(\"data-value\", (d) => d.value)\n        .attr(\"data-ratio\", (d) => d.value / this.totalValue)\n        .style(\n          \"font-size\",\n          (d) => VoronoiTreemapHelpers.fontScale(this.hierarchy, d) + \"em\"\n        )\n        .attr(\"paint-order\", \"stroke\")\n        .style(\"fill\", (d) =>\n          VoronoiTreemapHelpers.colorVar2(d.parent.color, 0, 0.2, -0.2)\n        )\n        .attr(\n          \"transform\",\n          (d) =>\n            `translate(${[\n              d.polygon.site.x,\n              d.polygon.site.y +\n                VoronoiTreemapHelpers.getLabelHeightOffset(this, d)\n            ]})`\n        )\n        .html((d) => VoronoiTreemapHelpers.multiline(d.data.key))\n        .attr(\"opacity\", (d) =>\n          d.value / this.totalValue >= ratioLimit ? 1 : 0\n        );\n    }\n  }\n\n  _drawPercentLabels() {\n    const { showPercent } = this.params;\n    const percent_label_depth =\n      this.allNodes.filter((d) => d.depth === 1).length > 1 ? 1 : 2;\n\n    this.percentLabelsGroup\n      .selectAll(\"text\")\n      .data(this.allNodes.filter((d) => d.depth === percent_label_depth))\n      .enter()\n      .append(\"text\")\n      .attr(\"class\", (d) => `budget percent label-${d.id}`)\n      .attr(\"text-anchor\", \"middle\")\n      .style(\n        \"font-size\",\n        (d) => VoronoiTreemapHelpers.fontScale(this.hierarchy, d) * 0.8 + \"em\"\n      )\n      .attr(\n        \"transform\",\n        (d) =>\n          `translate(${[\n            d.polygon.site.x,\n            d.polygon.site.y +\n              VoronoiTreemapHelpers.fontScale(this.hierarchy, d) *\n                8 *\n                (VoronoiTreemapHelpers.multiline(d.data.key, true)[1] + 2.2)\n          ]})`\n      )\n      .text((d) => \" \" + d3.format(\".0%\")(d.value / this.totalValue))\n      .attr(\"opacity\", (d) =>\n        showPercent\n          ? Math.round((d.value / this.totalValue) * 100) > 0\n            ? 1\n            : 0\n          : 0\n      );\n  }\n\n  _drawSectorLabels() {\n    const { underLabel, ratioLimit } = this.params;\n\n    this.labelsGroup\n      .selectAll(\"text\")\n      .data(this.allNodes.filter((d) => d.depth === 3))\n      .enter()\n      .append(\"text\")\n      .attr(\"class\", (d) => `sector label-${d.id}`)\n      .attr(\"data-cluster\", (d) => d.data.key)\n      .attr(\"data-value\", (d) => d.value)\n      .attr(\"data-ratio\", (d) => d.value / this.totalValue)\n      .attr(\"text-anchor\", \"start\")\n      .style(\n        \"font-size\",\n        (d) => VoronoiTreemapHelpers.fontScale2(this.hierarchy, d) + \"em\"\n      )\n      .style(\"fill\", (d) =>\n        VoronoiTreemapHelpers.getHSLColor(d.color, 0, -0.1, -0.3)\n      )\n      .attr(\"transform\", (d) => {\n        return underLabel\n          ? `translate(${[\n              d.polygon.site.x,\n              d.polygon.site.y +\n                VoronoiTreemapHelpers.fontScale1(\n                  this.hierarchy,\n                  d.data.data.bigClusterLabel,\n                  d.parent.value\n                ) *\n                  8 *\n                  (VoronoiTreemapHelpers.multiline(\n                    d.data.data.bigClusterLabel,\n                    true\n                  )[1] +\n                    0.5)\n            ]})`\n          : `translate(${VoronoiTreemapHelpers.getLabelPos(this, d)})`;\n      })\n      .html((d) => VoronoiTreemapHelpers.multiline(d.data.key))\n      .attr(\"opacity\", (d) => (d.value / this.totalValue > ratioLimit ? 1 : 0));\n  }\n\n  _drawPopLabels() {\n    const { sizeLimit } = this.params;\n\n    this.popLabelsGroup\n      .selectAll(\"text\")\n      .data(this.allNodes.filter((d) => d.depth === 3))\n      .enter()\n      .append(\"text\")\n      .attr(\"class\", (d) => `budget label-${d.id}`)\n      .attr(\"text-anchor\", \"middle\")\n      .style(\n        \"font-size\",\n        (d) => VoronoiTreemapHelpers.fontScale2(this.hierarchy, d) * 0.8 + \"em\"\n      )\n      .attr(\n        \"data-pop\",\n        (d) => d.data.data.clusterLabel ?? d.data.data.bigClusterLabel\n      )\n      .attr(\n        \"transform\",\n        (d) =>\n          `translate(${[\n            d.polygon.site.x,\n            d.polygon.site.y + VoronoiTreemapHelpers.varFontScale(this, d)\n          ]})`\n      )\n      .text((d) => VoronoiTreemapHelpers.bigFormat(d.data.values[0].budget))\n      .attr(\"opacity\", (d) => (d.value > sizeLimit ? 1 : 0));\n  }\n\n  // === 4. Post-processing and Effects Methods ===\n\n  _applyPostEffects() {\n    const { showRegion, pebbleRound, pebbleWidth } = this.params;\n\n    if (showRegion) {\n      this.labelAdjuster.adjust(this.svg.node(), { verticalSpacing: 0 });\n    }\n\n    this.pebbleRenderer.render(\n      this.svg.node(),\n      pebbleRound,\n      pebbleWidth,\n      VoronoiTreemapHelpers.colorVar.bind(VoronoiTreemapHelpers)\n    );\n  }\n}\n\nexport default VoronoiTreemap;\n","/**\n * PopupHelpers\n *\n * Helper functions for creating popup displays when cells are clicked.\n * These are optional utilities that can be used with the clickFunc option.\n */\n\n/**\n * Default popup function for Observable notebooks\n * Returns an HTML element that displays information about the clicked cell\n *\n * @param {Object} clickedData - The data object passed from the click event\n * @param {Object} clickedData.data - The data associated with the clicked cell\n * @param {Event} clickedData.event - The original click event\n * @returns {HTMLElement|null} HTML element for Observable to display, or null if no data\n *\n * @example\n * // In Observable notebook\n * import { VoronoiTreemap, showVoronoiPopup } from \"...\"\n *\n * chart = {\n *   const treemap = new VoronoiTreemap();\n *   return treemap.render(data, {\n *     clickFunc: showVoronoiPopup\n *   });\n * }\n */\nexport function showVoronoiPopup(clickedData) {\n  if (!clickedData) return null;\n\n  const data = clickedData.data || {};\n\n  // This uses Observable's html template literal\n  // For non-Observable environments, use createDOMPopup instead\n  if (typeof html !== 'undefined') {\n    return html`<div style=\"\n      background: #fffe;\n      border: 2px solid #555;\n      border-radius: 15px;\n      padding: 15px;\n      max-width: 350px;\n      min-width: 200px;\n    \">\n      <div style=\"font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em;\">\n        ${data.bigClusterLabel || 'N/A'}\n      </div>\n      <div style=\"margin-bottom: 0.3em;\">\n        <strong>Region:</strong> ${data.region || 'N/A'}\n      </div>\n      <div>\n        <strong>Size:</strong> ${data.bubbleSize || 'N/A'}\n      </div>\n    </div>`;\n  }\n\n  // Fallback for non-Observable environments\n  return createDOMPopup(clickedData);\n}\n\n/**\n * Create a DOM-based popup for standard web pages (non-Observable)\n * This creates an absolutely positioned popup at the click location\n *\n * @param {Object} clickedData - The data object passed from the click event\n * @param {Object} clickedData.data - The data associated with the clicked cell\n * @param {Event} clickedData.event - The original click event\n * @returns {HTMLElement|null} DOM element to be appended to the page\n *\n * @example\n * // In standard HTML/JavaScript\n * const treemap = new VoronoiTreemap();\n * const svg = treemap.render(data, {\n *   clickFunc: createDOMPopup\n * });\n */\nexport function createDOMPopup(clickedData) {\n  // Remove existing popup\n  const existingPopup = document.querySelector('.voronoi-popup-content');\n  if (existingPopup) existingPopup.remove();\n\n  if (!clickedData) {\n    return null;\n  }\n\n  const event = clickedData.event;\n  const data = clickedData.data || {};\n\n  // Create popup\n  const popup = document.createElement('div');\n  popup.className = 'voronoi-popup-content';\n\n  // Position at click location\n  const x = event.pageX;\n  const y = event.pageY;\n  popup.style.left = x + 'px';\n  popup.style.top = y + 'px';\n\n  // Create popup content\n  const content = document.createElement('div');\n  content.className = 'voronoi-popup-message';\n  content.innerHTML = `\n    <div style=\"font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em;\">\n      ${data.bigClusterLabel || 'N/A'}\n    </div>\n    <div style=\"margin-bottom: 0.3em;\">\n      <strong>Region:</strong> ${data.region || 'N/A'}\n    </div>\n    <div>\n      <strong>Size:</strong> ${data.bubbleSize || 'N/A'}\n    </div>\n  `;\n\n  popup.appendChild(content);\n  document.body.appendChild(popup);\n\n  // Close on click outside\n  setTimeout(() => {\n    const closeHandler = (e) => {\n      if (!popup.contains(e.target)) {\n        popup.remove();\n        document.removeEventListener('click', closeHandler);\n      }\n    };\n    document.addEventListener('click', closeHandler);\n  }, 0);\n\n  return popup;\n}\n\n/**\n * Get the recommended CSS styles for popups\n * Returns a string of CSS that can be added to your page\n *\n * @returns {string} CSS string for popup styles\n *\n * @example\n * // In Observable\n * html`<style>${getPopupStyles()}</style>`\n *\n * @example\n * // In standard HTML\n * const style = document.createElement('style');\n * style.textContent = getPopupStyles();\n * document.head.appendChild(style);\n */\nexport function getPopupStyles() {\n  return `\n.voronoi-popup-content {\n  position: absolute;\n  background: #fffe;\n  border: 2px solid #555;\n  border-radius: 30px;\n  padding: 10px;\n  z-index: 1000000;\n  transform: translateX(-50%) translateY(-100%);\n  min-width: 100px;\n}\n\n.voronoi-popup-content::before {\n  content: \" \";\n  position: absolute;\n  top: 100%;\n  left: 50%;\n  margin-left: -10px;\n  border-width: 10px;\n  border-style: solid;\n  border-color: #555 transparent transparent transparent;\n}\n\n.voronoi-popup-content::after {\n  content: \" \";\n  position: absolute;\n  top: 100%;\n  left: 50%;\n  margin-left: -8px;\n  border-width: 8px;\n  border-style: solid;\n  border-color: #fff transparent transparent transparent;\n}\n\n.voronoi-popup-message {\n  max-width: 350px;\n  min-width: 200px;\n  padding: 1em;\n  line-height: 1.5;\n  color: #444;\n  text-align: left;\n  max-height: 400px;\n  overflow-y: scroll;\n  overflow-x: clip;\n}\n`;\n}\n\nexport default {\n  showVoronoiPopup,\n  createDOMPopup,\n  getPopupStyles\n};\n"],"names":["d3","Object","assign","d3Core","d3WeightedVoronoi","d3VoronoiMap","d3VoronoiTreemap","seedrandom","seedrandomModule","default","PebbleRenderer","constructor","d3Instance","this","render","treemap","round","width","colorVarFunc","cell","select","empty","chartGroup","node","parentNode","remove","outlineGroup","insert","attr","outlineGroup2","_renderDepth2Outlines","_renderDepth1Outlines","self","selectAll","each","datum","path","polygon","cellColor","parent","color","_defaultColorVar","style","length","originalPath","map","p","join","smoothedPath","smoothPath","append","pathData","cornerRadius","minDistanceThreshold","rawPoints","replace","split","d","trim","Number","filter","x","y","isNaN","simplifiedPoints","_simplifyPoints","n","newPath","i","p0","p1","p2","vIn","vOut","lenIn","Math","hypot","lenOut","inNorm","outNorm","dot","angle","acos","max","min","adjustedRadius","PI","halfAngle","maxRadiusByLength","tan","pStart","pEnd","tempPoints","lastPoint","currentPoint","push","firstPoint","lastAddedPoint","pop","h","l","s","c","hsl","formatHex","LabelAdjuster","adjust","options","verticalSpacing","delay","checkOverlap","box1","box2","margin","height","getLabelBox","element","bbox","getBBox","tspanCount","size","transform","match","parseFloat","parseTransform","originalX","originalY","getCellBounds","data","xs","ys","minX","maxX","minY","maxY","findMinimumMove","labelBox","parentBox","cellBounds","box1Top","box1Bottom","box2Top","box2Bottom","getRequiredMoveDistance","originallyAbove","newY","proposedY","setTimeout","svg","fieldLabel","parentRegionElement","key","nodes","regionLabel","fieldBox","regionBox","regionKey","String","newPos","adjustFieldLabel","sectorLabel","parentFieldElement","sectorBox","adjustSectorLabel","nestingForVoronoi","key1","key2","simpleBudget","region","budget","bubbleSize","nested","rollups","sum","v","makeDictionary","bc","bcData","k","item","originalData","values","raw","regionData","VoronoiTreemapHelpers","fontScale","hierarchy","ratio","value","scaleLog","domain","range","fontScale1","string","fontScale2","varFontScale","text","clusterLabel","bigClusterLabel","cols","rows","multiline","getHSLColor","hslColor","copy","colorVar","colorVar2","colorvariation","vdomain","desc","extent","vScale","scaleLinear","colorHierarchy","depth","regionColor","children","params","colorFunc","parentColor","siblings","forEach","child","getBoxInfo","inputText","isLatinText","test","forcedLineBreaks","allLines","line","words","currentLines","count","lineCount","word","filteredLines","concat","charWidths","j","t","f","r","I","w","W","m","M","a","e","o","u","A","E","O","U","N","S","lineWidths","trimmedLine","Array","from","reduce","char","calculateTextWidth","maxLength","html","getLabelHeightOffset","fontSize","lineRows","getLabelPos","parentCenter","site","currentCenter","diffX","diffY","offY","offX","meanWidth","boxHeight","boxWidth","minOffset","abs","parentBounds","getPolygonBounds","proposedX","point","estimatePolygonRadius","area","originalObject","sqrt","estimateLabelWidth","fontMultiplier","maxWidth","estimateLabelHeight","createLabelContext","totalValue","percentText","format","darkerColor","lighterColor","centerX","centerY","formatNumber","bigFormat","formatPercent","floor","parseInt","createCustomVoronoiAlgorithm","debug","DEFAULT_PRNG","random","clip","convergenceRatio","maxIterationCount","minWeightRatio","prng","initialPositions","_convenientReusableVoronoiMapSimulation","voronoiMapSimulation","weight","stop","helpers","_voronoiTreemap","rootNode","recurse","_","arguments","clippingPolygon","simulation","state","initialPosition","createInitialPositioner","ended","tick","polygons","cp","dx","dy","findNodeInitialPosition","find","pos","arr","shouldUpdateInternals","siblingInitialPositions","sibling","undefined","getSiblingInitialPositions","siblingXExtent","siblingYExtent","nodeInitialPosition","polygonContains","mappedX","mappedY","polygonAngles","atan2","normalizedAngle","startAngle","endAngle","startPoint","endPoint","edgeX","edgeY","polygonXExtent","polygonYExtent","mapPointToPolygon","sort","b","getPolygonAngles","escapeCSSSelector","str","VoronoiTreemap","top","right","bottom","left","allNodes","_pebbleRenderer","_labelAdjuster","DEFAULT_COLORS","DEFAULT_OPTIONS","maptitle","caption","clickFunc","sizeLimit","ratioLimit","pieSize","colors","seedRandom","showRegion","showPercent","underLabel","regionPositions","forceNodeFunc","pebbleRound","pebbleWidth","regionColors","regionLabelRenderer","bigClusterLabelRenderer","pebbleRenderer","labelAdjuster","_setupSVG","_prepareData","_setupGroups","_drawTitleAndCaption","_createRegionColorScale","_computeLayout","_drawCells","_drawLabels","_applyPostEffects","update","newData","create","voronoiGroup","labelsGroup","popLabelsGroup","bigLabelsGroup","percentLabelsGroup","regionLabelsGroup","categories","Set","cellColors","regionColorKeys","regionColorValues","colorMapping","scaleOrdinal","keys","ellipse","cos","sin","seed","voronoiTreemap","voronoiTreeMap","mergedPositions","_normalizePositions","modifiedVoronoiTreeMap","descendants","id","result","hierarchyNodes","depth1","xExtent","yExtent","xScale","yScale","depthPositions","nodesAtDepth","group","parentKey","siblingKeys","siblingPositions","has","enter","on","clicked","classed","event","clickArea","label1","label","_drawRegionLabels","_drawBigClusterLabels","_drawPercentLabels","_drawSectorLabels","_drawPopLabels","regionNodes","bounds","defaultHtml","context","bigClusterNodes","percent_label_depth","bind","createDOMPopup","clickedData","existingPopup","document","querySelector","popup","createElement","className","pageX","pageY","content","innerHTML","appendChild","body","closeHandler","contains","target","removeEventListener","addEventListener"],"mappings":"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"}